#!/usr/bin/env bash
set -e

rc_file=$RCFILE
if [ -z "$RCFILE" ]; then
  rc_file="$(realpath ~/)/.apply-psqlrc"
fi

if [ -z "$PGHOST" ]; then
  eval $(cat "${rc_file}" 2>/dev/null)
fi

if [ -z "$PGHOST" ]; then
  read -p 'Host: ' PGHOST
  read -p 'Port: ' PGPORT
  read -p 'User(master): ' PGUSER
  read -p 'Database: ' PGDATABASE
  read -sp 'Password: ' PGPASSWORD

  export PGPASSWORD="${PGPASSWORD}"

  touch "${rc_file}"
  > "${rc_file}"

  echo "export PGHOST='${PGHOST}'" >>"${rc_file}"
  echo "export PGPORT='${PGPORT}'" >>"${rc_file}"
  echo "export PGUSER='${PGUSER}'" >>"${rc_file}"
  echo "export PGDATABASE='${PGDATABASE}'" >>"${rc_file}"
  echo "export PGPASSWORD='${PGPASSWORD}'" >>"${rc_file}"
fi

PGUSER="${PGUSER:-master}"

psql="psql -U ${PGUSER} -h ${PGHOST} -p ${PGPORT} -d ${PGDATABASE}"

echo $psql

case "$1" in
  apply)
    if [ -d ./db ]; then
      cd ./db
    fi

    for f in *.sql; do
      $psql -a -f $f 2>&1 | grep --color=always -E 'ERROR|$' | GREP_COLOR='01;36' grep --color -E 'WARNING|NOTICE|$'
    done

    exit $?
    ;;
  *)
    $psql
    exit $?
    ;;
esac

